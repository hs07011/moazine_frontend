<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>moazin 관광지 및 맛집 안내 서비스</title>
  <style>
    body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Segoe UI', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
      background: linear-gradient(135deg, #232526 0%, #414345 100%);
      color: #f5f5f5;
    }
    h1 {
      font-size: 2.7rem;
      color: #ffd700;
      text-shadow: 1px 2px 8px #222, 0 1px 0 #fff;
      margin-top: 32px;
      margin-bottom: 18px;
      letter-spacing: 2px;
      font-family: 'Nanum Myeongjo', serif;
      text-align: center;
    }
    #controls {
      margin: 24px auto 18px auto;
      text-align: center;
    }
    #destination {
      padding: 8px 14px;
      border-radius: 6px;
      border: 1px solid #bbb;
      font-size: 1.1rem;
      width: 220px;
    }
    #searchBtn {
      padding: 8px 18px;
      border-radius: 6px;
      border: none;
      background: #ffd700;
      color: #232526;
      font-weight: bold;
      font-size: 1.1rem;
      margin-left: 8px;
      cursor: pointer;
      box-shadow: 0 2px 8px #2224;
      transition: background 0.2s;
    }
    #searchBtn:hover {
      background: #ffea70;
    }
    #map {
      width: 90vw;
      height: 260px;
      margin: 0 auto 18px auto;
      border-radius: 0;
      border: 2.5px solid #ffd700;
      box-shadow: 0 8px 32px #000a, 0 1.5px 0 #fff;
      overflow: hidden;
      display: block;
    }
    #lists {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      width: 90vw;
      margin: 0 auto 0 auto;
      gap: 0;
    }
    .list-section {
      background: rgba(34, 36, 38, 0.85);
      border-radius: 0;
      padding: 18px 22px 12px 22px;
      min-width: 270px;
      width: 48%;
      box-shadow: 0 2px 12px #0005;
      border: 2px solid #ffd700;
    }
    .list-section h2 {
      color: #ffd700;
      font-size: 1.3rem;
      margin-bottom: 10px;
      font-family: 'Nanum Myeongjo', serif;
    }
    .place-item {
      cursor: pointer;
      margin: 8px 0;
      padding: 8px 10px;
      border: 1px solid #ffd70044;
      border-radius: 0;
      background: #232526cc;
      color: #fff;
      transition: background 0.2s, color 0.2s;
    }
    .place-item:hover {
      background: #ffd700;
      color: #232526;
    }
    #info {
      margin: 32px auto 0 auto;
      max-width: 600px;
      background: rgba(34,36,38,0.92);
      border-radius: 0;
      box-shadow: 0 2px 16px #0007;
      padding: 24px 32px;
      color: #fff;
      font-size: 1.1rem;
      display: none;
      border: 2px solid #ffd700;
    }
    #info img {
      max-width: 100%;
      border-radius: 0;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px #0005;
    }
    @media (max-width: 900px) {
      #lists { flex-direction: column; align-items: center; gap: 18px; width: 98vw; }
      .list-section { min-width: 180px; width: 98vw; }
      #map { width: 98vw; }
    }
  </style>
</head>
<body>
  <h1>moazin 관광지 및 맛집 안내 서비스</h1>
  <div id="controls">
    <input id="destination" placeholder="목적지(예: 서울역)" />
    <button id="searchBtn">목적지 이동</button>
  </div>
  <div id="map"></div>
  <div id="lists">
    <div class="list-section">
      <h2>주요 관광지 (5개)</h2>
      <div id="attractions"></div>
    </div>
    <div class="list-section">
      <h2>주요 맛집 (5개)</h2>
      <div id="restaurants"></div>
    </div>
  </div>
  <div id="info"></div>
  <script>
    const PROXY = 'https://moazine.onrender.com';
    let map, marker, destLatLng, attractions = [], restaurants = [];

    // Google Maps JS API 동적 로드
    async function loadGoogleMapAPI() {
      const response = await fetch(`${PROXY}/map-key`);
      const { apiKey } = await response.json();
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&libraries=places`;
      script.async = true;
      document.head.appendChild(script);
    }

    window.initMap = function() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 37.5665, lng: 126.9780 },
        zoom: 13
      });
      // 현재 위치 마커
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude, lng = pos.coords.longitude;
          map.setCenter({ lat, lng });
          new google.maps.Marker({ position: { lat, lng }, map: map, title: '현재 위치' });
        });
      }
    };

    document.getElementById('searchBtn').onclick = function() {
      const dest = document.getElementById('destination').value;
      if (!dest) return alert('목적지를 입력하세요!');
      fetch(`${PROXY}/geocode?query=${encodeURIComponent(dest)}`)
      .then(res => res.json())
      .then(data => {
        if (data.results && data.results.length > 0) {
          const loc = data.results[0].geometry.location;
          destLatLng = { lat: loc.lat, lng: loc.lng };
          map.setCenter(destLatLng);
          if (marker) marker.setMap(null);
          marker = new google.maps.Marker({ position: destLatLng, map: map, title: '목적지' });
          loadPlaces();
        } else {
          alert('목적지를 찾을 수 없습니다.');
        }
      });
    };

    function loadPlaces() {
      document.getElementById('attractions').innerHTML = '관광지 목록을 불러오는 중...';
      document.getElementById('restaurants').innerHTML = '맛집 목록을 불러오는 중...';
      fetch(`${PROXY}/places?lat=${destLatLng.lat}&lng=${destLatLng.lng}`)
      .then(res => res.json())
      .then(data => {
        attractions = data.attractions || [];
        restaurants = data.restaurants || [];
        renderList('attractions', attractions);
        renderList('restaurants', restaurants);
      });
    }

    function renderList(type, list) {
      const container = document.getElementById(type);
      if (!list.length) {
        container.innerHTML = type === 'attractions' ? '주변 관광지를 찾을 수 없습니다.' : '주변 맛집을 찾을 수 없습니다.';
        return;
      }
      container.innerHTML = list.map((item, i) =>
        `<div class="place-item" data-type="${type}" data-idx="${i}">
          <b>${item.name}</b> <span style="color:#ffd700;">★${item.rating || '-'} </span>
        </div>`
      ).join('');
      container.querySelectorAll('.place-item').forEach(item => {
        item.onclick = function() {
          const idx = this.getAttribute('data-idx');
          const t = this.getAttribute('data-type');
          showPlaceInfo(t === 'attractions' ? attractions[idx] : restaurants[idx]);
        };
      });
    }

    function showPlaceInfo(place) {
      const name = place.name;
      const addr = place.vicinity || place.formatted_address || '';
      const rating = place.rating ? `평점: ${place.rating}` : '';
      const photo = place.photos && place.photos[0]
        ? `<img src="https://maps.googleapis.com/maps/api/place/photo?maxwidth=400&photoreference=${place.photos[0].photo_reference}&key=${window.google && google.maps ? google.maps.apiKey : ''}" alt="${name}">`
        : '';
      const infoHtml = `
        <h3 style="color:#ffd700; font-family:'Nanum Myeongjo',serif;">${name}</h3>
        ${photo}
        <p><b>주소:</b> ${addr}</p>
        <p><b>${rating}</b></p>
        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}" target="_blank" style="color:#ffd700;">상세 정보 보기</a>
        <span style="float:right;cursor:pointer;color:#ffd700;font-size:1.3em;" onclick="document.getElementById('info').style.display='none'">✕</span>
      `;
      const infoDiv = document.getElementById('info');
      infoDiv.innerHTML = infoHtml;
      infoDiv.style.display = 'block';
      // 음성 안내
      let msg = `${name}. 주소는 ${addr}. ${rating}`;
      const utter = new SpeechSynthesisUtterance(msg);
      utter.lang = 'ko-KR';
      speechSynthesis.speak(utter);
    }
