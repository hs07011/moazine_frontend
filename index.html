<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>주변 관광지 및 맛집 소개 HJM 서비스</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
      background: #f4f4f4;
      color: #222;
    }
    .header {
      background: #217093;
      color: #fff;
      padding: clamp(16px, 3vw, 36px) clamp(20px, 5vw, 60px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
    }
    .header-title {
      font-size: clamp(2.4rem, 5vw, 4.2rem);
      font-weight: bold;
      letter-spacing: 2px;
      margin: 0;
      white-space: nowrap;
      word-break: keep-all;
      min-width: 0;
    }
    .header-search {
      display: flex;
      align-items: center;
      background: #fff;
      border-radius: 4px;
      padding: clamp(6px, 1.5vw, 8px) clamp(10px, 2vw, 16px);
      flex-grow: 1;
      min-width: 0;
      max-width: 600px;
      margin: 0;
      transition: padding 0.2s;
      gap: 0;
    }
    #destination {
      border: none;
      outline: none;
      font-size: clamp(1.4rem, 2.5vw, 1.8rem);
      padding: clamp(8px, 1.5vw, 12px) clamp(10px, 2vw, 20px);
      width: 100%;
      background: transparent;
      flex-grow: 1;
      transition: padding 0.2s;
    }
    #searchBtn {
      background: #217093;
      color: #fff;
      border: none;
      font-size: clamp(1.4rem, 2.5vw, 1.8rem);
      font-weight: bold;
      padding: 12px 24px;
      border-radius: 4px;
      margin-left: 10px;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
      height: 100%;
      display: flex;
      align-items: center;
    }
    #searchBtn:hover {
      background: #14516b;
    }
    #scheduleBtn {
      background: #4caf50;
      color: #fff;
      font-weight: bold;
      border: none;
      font-size: clamp(1.4rem, 2.5vw, 1.8rem);
      padding: 12px 24px;
      border-radius: 4px;
      margin-left: auto;
      margin-right: 0;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
      height: 100%;
      display: flex;
      align-items: center;
    }
    #scheduleBtn:hover {
      background: #388e3c;
    }
    #scheduleBox {
      width: 100% !important;
      max-width: 640px !important;
      min-width: 320px !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      padding: 20px 0 20px 0 !important;
      box-sizing: border-box;
      position: relative;
    }
    #scheduleBox .close-btn {
      position: absolute;
      right: -24px;
      top: -24px;
      z-index: 10000;
      background: #fff;
      border-radius: 50%;
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.1rem;
      color: #888;
      font-weight: bold;
      box-shadow: 0 2px 8px #0002;
      border: 1.5px solid #e0e0e0;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    #scheduleBox .close-btn:hover {
      background: #217093;
      color: #fff;
    }
    @media (max-width: 1000px) {
      .summary-popup {
        width: 96vw;
        left: 2vw;
        min-width: 0;
        max-width: 98vw;
        padding: 18px 8px 14px 8px;
        font-size: 1.5rem;
        transform: none;
      }
      .destination-intro-popup {
        width: 96vw;
        left: 2vw;
        min-width: 0;
        max-width: 98vw;
        padding: 18px 8px 14px 8px;
        font-size: 1.5rem;
        transform: none;
      }
      .destination-intro-popup .title {
        font-size: 1.8rem;
        margin-bottom: 15px;
      }
      .destination-intro-popup .guide-text {
        font-size: 1.5rem;
        line-height: 1.6;
      }
      #scheduleBox {
        max-width: 99vw !important;
        min-width: 0 !important;
        padding: 8px 0 8px 0 !important;
      }
    }
    .details-popup {
      display: none;
      position: absolute;
      top: 50px;
      left: 50%;
      transform: translateX(-100%);
      width: 117vw;
      max-width: 780px;
      max-height: 80vh;
      background: #fff;
      border: 3px solid #333;
      border-radius: 12px;
      box-shadow: 0 8px 30px #0000004d;
      font-size: 1.6rem;
      color: #333;
      z-index: 2000;
      line-height: 1.7;
      overflow-y: auto;
    }
    .details-popup-content {
      padding: 24px;
      display: flex;
      flex-direction: column;
    }
    .details-popup .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
      font-size: 2rem;
      color: #aaa;
      font-weight: bold;
    }
    .details-popup-header {
      font-size: 2.4rem;
      font-weight: bold;
      color: #217093;
      margin-bottom: 16px;
      border-bottom: 2px solid #eee;
      padding-bottom: 12px;
    }
    .details-popup-content .detail-item {
      margin-bottom: 12px;
      display: grid;
      grid-template-columns: max-content 1fr;
      align-items: center;
      gap: 15px;
    }
    .details-popup-content .detail-item .label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: bold;
      color: #555;
    }
    .details-popup-content .detail-item .value {
      overflow-wrap: break-word;
    }
    .details-popup-content .detail-item .value a {
      color: #1a0dab;
      text-decoration: none;
      font-weight: 500;
    }
    .details-popup-content .detail-item .value a:hover {
      text-decoration: underline;
    }
    .details-popup .reviews-section {
      margin-top: 20px;
      border-top: 2px solid #eee;
      padding-top: 15px;
    }
    .details-popup .reviews-section .review {
      margin-bottom: 15px;
      font-size: 1.4rem;
      line-height: 1.6;
    }
    .details-popup .reviews-section .review-author {
      font-weight: bold;
      color: #217093;
    }
    @media (max-width: 600px) {
      .details-popup {
        font-size: 1.4rem;
      }
      .details-popup-header {
        font-size: 2rem;
      }
    }
    .schedule-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 0 8px;
      box-sizing: border-box;
    }
    .schedule-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 16px #0001;
      margin: 18px 0;
      padding: 28px 28px 22px 28px;
      max-width: 600px;
      border-left: 6px solid #217093;
      box-sizing: border-box;
    }
    .schedule-title {
      font-size: 1.35rem;
      font-weight: bold;
      color: #217093;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .schedule-desc p {
      margin: 0 0 14px 0;
      line-height: 1.35;
      color: #222;
      font-size: 1.13rem;
      word-break: keep-all;
    }
    .schedule-desc blockquote {
      background: #f4f8fa;
      border-left: 4px solid #4caf50;
      margin: 12px 0 12px 0;
      padding: 10px 18px;
      color: #217093;
      font-style: italic;
      font-size: 1.04rem;
    }
    .schedule-rating {
      margin-top: 10px;
      color: #ff9800;
      font-weight: bold;
      font-size: 1.13rem;
    }
    .schedule-section-title {
      font-size: 1.13rem;
      font-weight: bold;
      color: #217093;
      background: #e3f2fd;
      border-radius: 8px;
      padding: 8px 12px;
      margin: 24px 0 10px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-title">Travel Here Service</div>
    <div class="header-search">
      <input id="destination" placeholder="현재 위치 검색 결과" style="color:#888;" />
      <button id="searchBtn">검색</button>
      <button id="scheduleBtn" style="margin-left:8px;background:#4caf50;color:#fff;font-weight:bold;">여행스케줄 작성</button>
    </div>
  </div>
  <div class="main">
    <div class="map-container">
      <div id="map"></div>
      <div id="summaryBox" class="summary-popup" style="display:none;"></div>
      <div id="destinationIntroBox" class="destination-intro-popup" style="display:none;"></div>
      <div id="scheduleBox" class="destination-intro-popup" style="display:none;"></div>
    </div>
    <div class="side-tables">
      <div class="table-section attraction-table">
        <div class="table-title">
          <button id="attractionSummaryBtn" class="summary-btn">요약</button>
          <img src="/assets/attraction.png" alt="관광지" style="vertical-align:middle;width:3.52rem;height:3.52rem;margin:0 10px 0 10px;">
          관광지 10선
        </div>
        <div class="table-container">
          <table id="attractionTable">
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="table-section restaurant-table">
        <div class="table-title">
          <button id="restaurantSummaryBtn" class="summary-btn">요약</button>
          <img src="/assets/restaurant.png" alt="맛집" style="vertical-align:middle;width:3.52rem;height:3.52rem;margin:0 10px 0 10px;">
          맛집 10선
        </div>
        <div class="table-container">
          <table id="restaurantTable">
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div id="placeDetailsBox" class="details-popup" style="display:none;"></div>
  <script>
    const PROXY = 'https://moazine.onrender.com';
    let map, marker, destLatLng, attractions = [], restaurants = [];
    let placeMarkers = [];
    let speechVoices = [];

    function loadVoices() {
      speechVoices = window.speechSynthesis.getVoices();
    }
    loadVoices();
    if (window.speechSynthesis.onvoiceschanged !== undefined) {
      window.speechSynthesis.onvoiceschanged = loadVoices;
    }

    // Google Maps JS API 동적 로드
    async function loadGoogleMapAPI() {
      const response = await fetch(`${PROXY}/map-key`);
      const { apiKey } = await response.json();
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&libraries=places`;
      script.async = true;
      document.head.appendChild(script);
    }

    window.initMap = function() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 37.5665, lng: 126.9780 },
        zoom: 14
      });
      // 첫 진입 시 현재 위치로 자동 검색
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude, lng = pos.coords.longitude;
          map.setCenter({ lat, lng });
          if (marker) marker.setMap(null);
          marker = new google.maps.Marker({ position: { lat, lng }, map: map, title: '현재 위치', icon: { url: '/assets/current.png', scaledSize: new google.maps.Size(48, 48) } });
          destLatLng = { lat, lng };
          
          // 현재 위치의 행정주소 가져오기
          fetch(`${PROXY}/reverse-geocode?lat=${lat}&lng=${lng}`)
          .then(res => res.json())
          .then(data => {
            // 행정주소는 내부적으로만 저장하고 입력란에는 표시하지 않음
            document.getElementById('destination').value = '';
            document.getElementById('destination').placeholder = '현재 위치 검색 결과';
            document.getElementById('destination').style.color = '#888';
            loadPlaces(true);
          })
          .catch(() => {
            document.getElementById('destination').value = '';
            document.getElementById('destination').placeholder = '현재 위치 검색 결과';
            document.getElementById('destination').style.color = '#888';
            loadPlaces(true);
          });
        }, () => {
          // 위치 권한 거부 시 서울 기본
          document.getElementById('destination').value = '';
          document.getElementById('destination').placeholder = '현재 위치 검색 결과';
          document.getElementById('destination').style.color = '#888';
          loadPlaces(true);
        });
      } else {
        document.getElementById('destination').value = '';
        document.getElementById('destination').placeholder = '현재 위치 검색 결과';
        document.getElementById('destination').style.color = '#888';
        loadPlaces(true);
      }
    };

    document.getElementById('destination').onfocus = function() {
      this.style.color = '#222';
      if (this.value === '') this.placeholder = '';
    };
    document.getElementById('destination').onblur = function() {
      if (this.value === '') {
        this.placeholder = '현재 위치 검색 결과';
        this.style.color = '#888';
      }
    };

    document.getElementById('searchBtn').onclick = function() {
      const dest = document.getElementById('destination').value;
      if (!dest) return alert('목적지를 입력하세요!');
      fetch(`${PROXY}/geocode?query=${encodeURIComponent(dest)}`)
      .then(res => res.json())
      .then(data => {
        if (data.results && data.results.length > 0) {
          const loc = data.results[0].geometry.location;
          const placeName = data.results[0].formatted_address;
          destLatLng = { lat: loc.lat, lng: loc.lng };
          map.setCenter(destLatLng);
          if (marker) marker.setMap(null);
          marker = new google.maps.Marker({ position: destLatLng, map: map, title: '목적지' });
          document.getElementById('destination').style.color = '#222';
          // 원래 검색어를 유지하고 행정주소는 표시하지 않음
          // document.getElementById('destination').value = placeName;
          // 목적지 소개 표시 (Gemini API 호출)
          showDestinationIntro(dest, placeName, destLatLng);
          loadPlaces(false);
        } else {
          alert('목적지를 찾을 수 없습니다.');
        }
      })
      .catch(error => {
        console.error('지오코딩 에러:', error);
        alert('검색 중 오류가 발생했습니다.');
      });
    };

    // 검색창에서 엔터키 입력 시에도 검색 동작
    document.getElementById('destination').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('searchBtn').click();
      }
    });

    function clearPlaceMarkers() {
      placeMarkers.forEach(m => m.setMap(null));
      placeMarkers = [];
    }

    function loadPlaces(isCurrentLocation) {
      clearPlaceMarkers();
      let url = `${PROXY}/places?lat=${destLatLng.lat}&lng=${destLatLng.lng}&radius=5000`;
      fetch(url)
      .then(res => res.json())
      .then(data => {
        attractions = data.attractions || [];
        restaurants = data.restaurants || [];
        renderTable('attractionTable', attractions, '관광지');
        renderTable('restaurantTable', restaurants, '맛집');
        // 관광지/맛집 마커 표시 (아이콘 적용)
        attractions.forEach(place => {
          if (place.geometry && place.geometry.location) {
            const m = new google.maps.Marker({
              position: place.geometry.location,
              map: map,
              title: place.name,
              icon: {
                url: '/assets/attraction.png',
                scaledSize: new google.maps.Size(48, 48)
              }
            });
            m.addListener('click', function() {
              window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}`,'_blank');
            });
            placeMarkers.push(m);
          }
        });
        restaurants.forEach(place => {
          if (place.geometry && place.geometry.location) {
            const m = new google.maps.Marker({
              position: place.geometry.location,
              map: map,
              title: place.name,
              icon: {
                url: '/assets/restaurant.png',
                scaledSize: new google.maps.Size(48, 48)
              }
            });
            m.addListener('click', function() {
              window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}`,'_blank');
            });
            placeMarkers.push(m);
          }
        });
        // 검색창 표시
        if (isCurrentLocation) {
          // 현재 위치인 경우 이미 행정주소가 설정되어 있으므로 추가 설정 불필요
        } else {
          // 검색한 목적지인 경우 이미 행정주소가 설정되어 있음
        }
      });
    }

    function renderTable(tableId, list, type) {
      const tbody = document.getElementById(tableId).querySelector('tbody');
      let html = '';
      
      if (list.length === 0) {
        // 데이터가 없을 때 5개의 빈 항목 표시
        for (let i = 0; i < 5; i++) {
          html += `<tr><td style='width:36px;text-align:center;color:#888;'>${i+1}.</td><td style='color:#888;'>현재 위치에서 추천할 곳이 없습니다</td><td class='score'></td></tr>`;
        }
      } else {
        // 데이터가 있을 때 모든 항목 표시 (5개 이상이어도 모두 표시)
        html = list.map((item, i) =>
          `<tr class="clickable" onclick="showPlaceInfo('${type}', '${item.place_id}')">
            <td style="width:36px;text-align:center;">${i+1}.</td>
            <td>${item.name}</td>
            <td class="score">${item.rating ? item.rating.toFixed(1) + '점' : '-'}</td>
          </tr>`
        ).join('');
        
        // 5개 미만일 때만 빈 항목으로 채움
        if (list.length < 5) {
          for (let i = list.length; i < 5; i++) {
            html += `<tr><td style='width:36px;text-align:center;color:#888;'>${i+1}.</td><td style='color:#888;'>현재 위치에서 추천할 곳이 없습니다</td><td class='score'></td></tr>`;
          }
        }
      }
      tbody.innerHTML = html;
    }

    window.showPlaceInfo = function(type, placeId) {
      if (!placeId) {
        alert('장소 정보를 가져올 수 없습니다.');
        return;
      }

      const box = document.getElementById('placeDetailsBox');
      box.innerHTML = `<div style="padding: 40px; text-align:center;">상세 정보를 불러오는 중입니다...</div>`;
      box.style.display = 'block';

      fetch(`${PROXY}/place-details?place_id=${placeId}`)
        .then(res => res.json())
        .then(details => {
          if (details.error) throw new Error(details.error);
          
          let contentHtml = `<span class='close-btn' onclick="closeDetailsBox()">✕</span>`;
          
          let detailsHtml = `<div class="details-popup-content">`;
          detailsHtml += `<div class="details-popup-header">${details.name || '이름 정보 없음'}</div>`;
          
          const detailsContent = [
            { icon: '📍', text: '주소', value: details.formatted_address },
            { icon: '⭐', text: '평점', value: details.rating ? `${details.rating.toFixed(1)}점` : null },
            { icon: '📞', text: '연락처', value: details.formatted_phone_number, link: `tel:${details.formatted_phone_number}` },
            { icon: '💰', text: '가격대', value: details.price_level ? '₩'.repeat(details.price_level) : null },
            { icon: '🌐', text: '웹사이트', value: details.website, link: details.website }
          ];

          detailsContent.forEach(item => {
            if (item.value) {
              detailsHtml += `
                <div class="detail-item">
                  <div class="label">
                    <span class="icon">${item.icon}</span>
                    <span>${item.text}</span>
                  </div>
                  <div class="value">${item.link ? `<a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.value}</a>` : item.value}</div>
                </div>`;
            }
          });

          // 웹사이트가 있는 경우에만 메뉴/입장료 안내 문구 추가
          if (details.website) {
            const guidanceText = `자세한 ${type === '맛집' ? '메뉴' : '입장료'} 정보는 위 공식 웹사이트를 확인해주세요.`;
            detailsHtml += `
              <div class="detail-item">
                <div class="label">
                  <span class="icon">ℹ️</span>
                  <span>안내</span>
                </div>
                <div class="value"><small>${guidanceText}</small></div>
              </div>`;
          }

          detailsHtml += '</div>';

          if (details.reviews && details.reviews.length > 0) {
            detailsHtml += `<div class="reviews-section details-popup-content">`;
            detailsHtml += `
              <div class="detail-item">
                <div class="label" style="color: #217093;">
                  <span class="icon">🗣️</span>
                  <span>방문자 리뷰</span>
                </div>
              </div>`;
            details.reviews.slice(0, 2).forEach(review => {
              detailsHtml += `<div class="review">
                <div><span class="review-author">${review.author_name}</span> (${review.relative_time_description})</div>
                <p style="margin: 5px 0 0; white-space: pre-wrap;">${review.text}</p>
              </div>`;
            });
            detailsHtml += `</div>`;
          }
          
          box.innerHTML = contentHtml + detailsHtml;
        })
        .catch(err => {
          console.error('Failed to get place details:', err);
          box.innerHTML = `<span class='close-btn' onclick="closeDetailsBox()">✕</span><div style="padding: 40px; text-align:center;">상세 정보를 불러오지 못했습니다.</div>`;
        });
    };

    function closeDetailsBox() {
      document.getElementById('placeDetailsBox').style.display = 'none';
    }

    // 요약 정보 보기 버튼 이벤트
    document.getElementById('attractionSummaryBtn').onclick = function() {
      showSummary('관광지', attractions);
    };
    document.getElementById('restaurantSummaryBtn').onclick = function() {
      showSummary('맛집', restaurants);
    };

    function showSummary(type, list) {
      if (!list || list.length === 0) {
        showSummaryBox('요약할 정보가 없습니다.');
        return;
      }
      showSummaryBox('요약 정보를 불러오는 중...');
      fetch('https://moazine.onrender.com/summarize', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ places: list, type })
      })
      .then(res => res.json())
      .then(data => {
        showSummaryBox(data.summary || '요약 정보를 가져오지 못했습니다.');
      })
      .catch(() => showSummaryBox('요약 정보를 가져오지 못했습니다.'));
    }

    function getSpeechText(text) {
      // 1. 줄 시작의 번호를 한국어 서수로 먼저 변환합니다. (멀티라인 `m` 플래그 사용)
      let speech = text.replace(/^1\./gm, '첫번째')
                       .replace(/^2\./gm, '두번째')
                       .replace(/^3\./gm, '셋번째')
                       .replace(/^4\./gm, '네번째')
                       .replace(/^5\./gm, '다섯번째');

      // 2. 괄호와 괄호 안의 내용, 그 외 기호를 정리합니다.
      speech = speech
        .replace(/\([^\)]*\)/g, '') // ( ... ) 전체 제거
        .replace(/[\[\]\-·*=_~^|#@$%&+=→•▪︎🎯🌟🎒✈️👍✅✔💯❣️]/g, ' ') // 음성 출력에 불필요한 특수기호 및 이모지 제거
        .replace(/:/g, '은')
        .replace(/\//g, ' 또는 ')
        .replace(/평점/g, '평점은');

      // 3. 실수형 점수를 한국어로 변환합니다. (예: 4.5점 -> 4점5)
      speech = speech.replace(/(\d+)\.(\d+)점/g, '$1점$2');
      
      // 4. 서수나 평점으로 처리되지 않은, 본문에 남은 '숫자.' 형식의 점을 제거합니다.
      speech = speech.replace(/(\d)\./g, '$1');

      // 5. 마지막으로 줄바꿈과 여러 공백을 하나의 공백으로 통일합니다.
      speech = speech.replace(/\n/g, ' ').replace(/\s{2,}/g, ' ').trim();
        
      return speech;
    }

    function showSummaryBox(text) {
      const box = document.getElementById('summaryBox');
      box.innerHTML = `<span class='close-btn' onclick="closeSummaryBox()">✕</span>` + text;
      box.style.display = 'block';
      // 음성 출력 (여행 가이드 인트로, 옵션 조정)
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel(); // 기존 음성 중지
        const speechText = getSpeechText(text);
        const utter = new SpeechSynthesisUtterance(speechText);
        utter.lang = 'ko-KR';
        utter.rate = 1; // 자연스러운 속도
        utter.pitch = 1; // 자연스러운 높이
        // 자연스러운 한국어 voice 선택
        const koVoice = speechVoices.find(v => v.lang === 'ko-KR' && v.name.includes('Google'));
        if (koVoice) utter.voice = koVoice;
        window.speechSynthesis.speak(utter);
      }
    }

    function closeSummaryBox() {
      document.getElementById('summaryBox').style.display = 'none';
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
      }
    }

    function showDestinationIntro(searchQuery, placeName, latLng) {
      const box = document.getElementById('destinationIntroBox');
      box.innerHTML = `
        <span class='close-btn' onclick="closeDestinationIntro()">✕</span>
        <div class="title">🎯 ${searchQuery} 여행 가이드</div>
        <div class="guide-text">가이드 정보를 생성하는 중입니다... 잠시만 기다려주세요.</div>
      `;
      box.style.display = 'block';

      // 서버에 Gemini 소개 생성 요청
      fetch(`${PROXY}/generate-intro`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: searchQuery, address: placeName, lat: latLng.lat, lng: latLng.lng })
      })
      .then(res => res.json())
      .then(data => {
        const introText = data.intro.replace(/\n/g, '<br>'); // 줄바꿈을 <br>로
        const guideTextElement = box.querySelector('.guide-text');
        if (guideTextElement) {
          guideTextElement.innerHTML = introText;
        }

        // 음성 출력
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
          const speechText = getDestinationSpeechText(introText);
          const utter = new SpeechSynthesisUtterance(speechText);
          utter.lang = 'ko-KR';
          utter.rate = 1.0;
          utter.pitch = 1.0;
          const koVoice = speechVoices.find(v => v.lang === 'ko-KR' && v.name.includes('Google'));
          if (koVoice) utter.voice = koVoice;
          window.speechSynthesis.speak(utter);
        }
      })
      .catch(err => {
        console.error('Failed to get destination intro:', err);
        const guideTextElement = box.querySelector('.guide-text');
        if (guideTextElement) {
          guideTextElement.innerHTML = '가이드 정보 생성에 실패했습니다. 다시 시도해 주세요.';
        }
      });
    }

    function getDestinationSpeechText(text) {
      // HTML 태그 제거 및 음성용 텍스트 정리
      let speech = text.replace(/<[^>]*>/g, '') // HTML 태그 제거
                       .replace(/[\[\]\-·*=_~^|#@$%&+=→•▪︎🎯🌟🎒✈️👍✅✔💯❣️]/g, ' ') // 음성 출력에 불필요한 특수기호 및 이모지 제거
                       .replace(/\n/g, ' ') // 줄바꿈을 공백으로
                       .replace(/\s{2,}/g, ' ') // 여러 공백을 하나로
                       .trim();
      
      return speech;
    }

    function closeDestinationIntro() {
      document.getElementById('destinationIntroBox').style.display = 'none';
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
      }
    }

    document.getElementById('scheduleBtn').onclick = function() {
      const scheduleBtn = this;
      const originalText = scheduleBtn.textContent;
      
      // 로딩 상태 표시
      scheduleBtn.textContent = '생성 중...';
      scheduleBtn.disabled = true;
      scheduleBtn.style.background = '#ccc';
      
      const dest = document.getElementById('destination').value;
      
      // 1. 더 구체적인 검증
      if (!destLatLng) {
        alert('위치 정보를 가져올 수 없습니다. 페이지를 새로고침하거나 목적지를 다시 검색해 주세요.');
        resetScheduleBtn();
        return;
      }
      
      if (!attractions.length && !restaurants.length) {
        alert('주변 관광지와 맛집 정보가 없습니다. 다른 위치를 검색해 보세요.');
        resetScheduleBtn();
        return;
      }
      
      // 2. 로딩 상태 표시 개선
      showScheduleBox('여행 스케줄을 생성하는 중입니다...<br><small>잠시만 기다려주세요.</small>');
      
      // 3. 데이터 준비 및 검증
      const scheduleData = {
        destination: dest || '현재 위치',
        attractions: attractions.slice(0, 5), // 상위 5개만 사용
        restaurants: restaurants.slice(0, 5)  // 상위 5개만 사용
      };
      
      // 4. 에러 처리 개선된 API 호출
      fetch(`${PROXY}/generate-schedule`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(scheduleData)
      })
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        return res.json();
      })
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        const scheduleText = (data.schedule || '여행 스케줄을 가져오지 못했습니다.').replace(/\n/g, '<br>');
        showScheduleBox(scheduleText);
        resetScheduleBtn();
      })
      .catch(error => {
        console.error('Schedule generation error:', error);
        let errorMessage = '여행 스케줄을 가져오지 못했습니다.';
        
        if (error.message.includes('HTTP')) {
          errorMessage = '서버 연결에 문제가 있습니다. 잠시 후 다시 시도해 주세요.';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage = '인터넷 연결을 확인해 주세요.';
        }
        
        showScheduleBox(errorMessage);
        resetScheduleBtn();
      });
      
      // 버튼 상태 초기화 함수
      function resetScheduleBtn() {
        scheduleBtn.textContent = originalText;
        scheduleBtn.disabled = false;
        scheduleBtn.style.background = '#4caf50';
      }
    };

    function showScheduleBox(text) {
      const box = document.getElementById('scheduleBox');
      // 에러 메시지인지 확인
      const isError = text.includes('실패') || text.includes('문제') || text.includes('연결');
      let content = `<span class='close-btn' onclick="closeScheduleBox()">✕</span>`;
      content += `<div class="title">🗓️ 여행 스케줄</div>`;
      if (isError) {
        content += `<div class="guide-text" style="color: #d32f2f; text-align: center; padding: 20px;">`;
        content += `<div style="font-size: 1.2em; margin-bottom: 10px;">⚠️ ${text}</div>`;
        content += `<button onclick="retryScheduleGeneration()" style="background: #217093; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">다시 시도</button>`;
        content += `</div>`;
      } else {
        // Gemini가 반환한 HTML을 그대로 출력
        content += `<div class="schedule-container">${text}</div>`;
      }
      box.innerHTML = content;
      box.style.display = 'block';
    }

    // 카드 스타일로 변환하는 함수
    function convertScheduleToCards(text) {
      const schedulePattern = /\*\*스케줄\s*(\d+):\s*([^*]+)\*\*/g;
      let html = '';
      let lastIndex = 0;
      let match;
      let safety = 0; // 안전장치

      // 패턴이 하나도 없으면 안내 메시지
      if (!/\*\*스케줄\s*\d+:/.test(text)) {
        return '<div style="color:#888;text-align:center;padding:32px 0;">생성된 여행 일정이 없습니다.</div>';
      }
      schedulePattern.lastIndex = 0; // 패턴 재설정

      while ((match = schedulePattern.exec(text)) !== null && safety++ < 100) {
        const scheduleNum = match[1];
        const scheduleTitle = match[2].trim();
        const startIndex = match.index + match[0].length;
        const nextMatch = schedulePattern.exec(text);
        const endIndex = nextMatch ? nextMatch.index : text.length;
        const scheduleContent = text.substring(startIndex, endIndex);
        html += `<div class="schedule-section-title">📅 스케줄 ${scheduleNum}: ${scheduleTitle}</div>`;
        html += convertScheduleSectionToCards(scheduleContent);
        if (nextMatch) {
          schedulePattern.lastIndex = nextMatch.index;
        } else {
          break; // nextMatch 없으면 반드시 종료
        }
      }
      return html;
    }

    // 각 스케줄 섹션(표+설명)을 카드로 변환
    function convertScheduleSectionToCards(sectionText) {
      const lines = sectionText.split('\n').map(l => l.trim()).filter(Boolean);
      let cards = '';
      let lastTime = '', lastPlace = '', lastDesc = '', lastTip = '', lastRating = '', lastEmojis = '';
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        if (/^\|\s*시간\s*\|/i.test(line) || /^\|[-: ]+\|/.test(line)) continue;
        if (/^\|/.test(line)) {
          if (lastTime && lastPlace) {
            cards += renderScheduleCard(lastTime, lastPlace, lastDesc, lastTip, lastRating, lastEmojis);
          }
          const cells = line.split('|').map(c => c.trim());
          lastTime = cells[1] || '';
          lastPlace = cells[2] || '';
          lastDesc = cells[3] || '';
          lastTip = cells[4] || '';
          lastRating = cells[5] || '';
          lastEmojis = suggestPlaceEmoji(lastPlace, lastDesc);
        }
      }
      if (lastTime && lastPlace) {
        cards += renderScheduleCard(lastTime, lastPlace, lastDesc, lastTip, lastRating, lastEmojis);
      }
      return cards;
    }

    // 카드 렌더링
    function renderScheduleCard(time, place, desc, tip, rating, emoji) {
      // 설명을 2~3줄 단락으로 끊기
      const descParagraphs = desc.split(/(?<=\.)\s+/).filter(Boolean);
      let descHtml = '';
      for (let i = 0; i < descParagraphs.length; i += 2) {
        descHtml += `<p>${descParagraphs.slice(i, i + 2).join(' ')}</p>`;
      }
      let html = `<div class="schedule-card">
        <div class="schedule-title">🕘 ${time} – <b>${place}</b> ${emoji}</div>
        <div class="schedule-desc">${descHtml}`;
      if (tip && tip !== '없음') {
        html += `<blockquote>${tip.trim()}</blockquote>`;
      }
      if (rating) {
        html += `<div class="schedule-rating"><b>⭐ 평점: ${rating}</b></div>`;
      }
      html += `</div></div>`;
      return html;
    }

    // 장소명/설명에 따라 이모지 추천
    function suggestPlaceEmoji(place, desc) {
      const lower = (place + ' ' + desc).toLowerCase();
      if (/[모스크|성당|church|cathedral|mosque|temple|사원|절|이슬람|종교]/.test(lower)) return '🕌';
      if (/[공원|park|산|mountain|정원|garden|숲|forest|호수|lake|강|river]/.test(lower)) return '🌳';
      if (/[타워|전망대|tower|observatory]/.test(lower)) return '🗼';
      if (/[박물관|museum]/.test(lower)) return '🏛️';
      if (/[시장|market|마켓]/.test(lower)) return '🛍️';
      if (/[카페|cafe|커피|coffee]/.test(lower)) return '☕';
      if (/[식당|restaurant|맛집|food|grill|steak|bar|cafe|피자|pizza|한식|양식|중식|일식|분식|죽|비빔밥|steakhouse|grill|demiglace|outback|alvolo|albolo|alvollo|alvolo]/.test(lower)) return '🍽️';
      if (/[쇼핑|mall|백화점|shopping|plaza|square|광장]/.test(lower)) return '🏬';
      if (/[사진|포토|photo|촬영|전망|view|풍경|scenery|panorama|sunset|석양]/.test(lower)) return '📸';
      if (/[역|station|지하철|subway]/.test(lower)) return '🚉';
      if (/[호텔|hotel|숙소|guesthouse|hostel]/.test(lower)) return '🏨';
      return '';
    }

    // 다시 시도 함수 추가
    function retryScheduleGeneration() {
      document.getElementById('scheduleBtn').click();
    }

    function closeScheduleBox() {
      document.getElementById('scheduleBox').style.display = 'none';
      if ('speechSynthesis' in window) window.speechSynthesis.cancel();
    }

    // 페이지 로드 시 Google Maps API 로드 시작
    window.onload = function() {
      loadGoogleMapAPI();
    };
  </script>
</body>