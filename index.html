<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì£¼ë³€ ê´€ê´‘ì§€ ë° ë§›ì§‘ ì†Œê°œ HJM ì„œë¹„ìŠ¤</title>
  <script src="https://w.soundcloud.com/player/api.js" async></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
      background: #f4f4f4;
      color: #222;
    }
    .header {
      background: #217093;
      color: #fff;
      padding: clamp(16px, 3vw, 36px) clamp(20px, 5vw, 60px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
    }
    .header-title {
      font-size: clamp(2.4rem, 5vw, 4.2rem);
      font-weight: bold;
      letter-spacing: 2px;
      margin: 0;
      white-space: nowrap;
      word-break: keep-all;
      min-width: 0;
    }
    .header-search {
      display: flex;
      align-items: center;
      background: #fff;
      border-radius: 4px;
      padding: clamp(6px, 1.5vw, 8px) clamp(10px, 2vw, 16px);
      flex-grow: 1;
      min-width: 0;
      max-width: 600px;
      margin: 0;
      transition: padding 0.2s;
    }
    #destination {
      border: none;
      outline: none;
      font-size: clamp(1.4rem, 2.5vw, 1.8rem);
      padding: clamp(8px, 1.5vw, 12px) clamp(10px, 2vw, 20px);
      width: 100%;
      background: transparent;
      flex-grow: 1;
      transition: padding 0.2s;
    }
    #searchBtn {
      background: #217093;
      color: #fff;
      border: none;
      font-size: clamp(1.4rem, 2.5vw, 1.8rem);
      font-weight: bold;
      padding: 12px 24px;
      border-radius: 4px;
      margin-left: 10px;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    #searchBtn:hover {
      background: #14516b;
    }
    .main {
      display: flex;
      justify-content: space-between;
      padding: 32px 32px 0 32px;
      gap: 32px;
    }
    .map-container {
      flex: 1 1 0;
      min-width: 280px;
      max-width: 50vw;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 12px #0002;
      padding: 0;
      margin-right: 0;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
      border-radius: 8px;
    }
    .side-tables {
      flex: 1 1 0;
      min-width: 280px;
      max-width: 50vw;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .table-section {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 12px #0001;
      padding: 0 0 12px 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .table-title {
      font-size: 2.86rem;
      font-weight: bold;
      padding: 12px 0 12px 18px;
      text-align: left;
      letter-spacing: 1px;
    }
    .attraction-table {
      background: #d6f5d6;
    }
    .restaurant-table {
      background: #ffe5e0;
    }
    .table-container {
      flex: 1;
      overflow-y: auto;
      max-height: calc(100% - 60px);
      height: 100%;
      min-height: 0;
      display: flex;
      flex-direction: column;
      justify-content: stretch;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 2.2rem;
      height: 100%;
      table-layout: fixed;
    }
    th, td {
      padding: 8px 8px;
      text-align: left;
      height: 1%;
      vertical-align: middle;
      word-break: break-all;
      white-space: nowrap;
    }
    th {
      background: #f0f0f0;
      font-weight: bold;
    }
    tr {
      border-bottom: 1px solid #ccc;
      height: calc(10vh - 8px);
      min-height: 0;
      max-height: none;
    }
    tr:last-child {
      border-bottom: none;
    }
    td.score {
      text-align: right;
      font-weight: bold;
      font-size: 1em;
    }
    tr.clickable:hover {
      background: #b2e6b2 !important;
      cursor: pointer;
    }
    .restaurant-table tr.clickable:hover {
      background: #ffd6cc !important;
    }
    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
    .table-container::-webkit-scrollbar {
      width: 8px;
    }
    .table-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    .table-container::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }
    .table-container::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    @media (min-width: 1001px) {
      .main {
        align-items: stretch;
        min-height: 80vh;
      }
      .map-container, .side-tables {
        height: 80vh;
      }
      #map {
        min-height: 420px;
      }
      .table-section {
        flex: 1 1 0;
      }
    }
    @media (max-width: 1000px) {
      .main { flex-direction: column; gap: 18px; padding: 18px 4vw 32px 4vw; }
      .map-container, .side-tables { max-width: 100vw; width: 100%; height: auto; flex: none; }
      #map { height: 40vh; min-height: 300px; }
      .table-container { max-height: 300px; }
      .side-tables { max-width: 100vw; }
    }
    @media (max-width: 768px) {
      .header { flex-direction: column; align-items: stretch; }
      .header-title { text-align: center; white-space: normal; }
      .header-search { width: auto; max-width: none; }
    }
    @media (max-width: 600px) {
      .main { padding: 4px 1vw 16px 1vw; }
      .map-container, .side-tables { min-width: 0; }
      #map { height: 200px; min-height: 200px; }
      .table-title { font-size: 1.1rem; padding: 8px 0 8px 8px; }
      table { font-size: 1.1rem; }
      th, td { padding: 10px 6px; }
      .side-tables { gap: 10px; }
      .table-section img { width: 1.2rem !important; height: 1.2rem !important; }
      .table-container { max-height: 250px; }
      .table-container::-webkit-scrollbar { width: 4px; }
      .details-popup {
        position: fixed !important;
        width: 96vw !important;
        max-width: 98vw !important;
        left: 50% !important;
        top: 30px !important;
        transform: translateX(-50%) !important;
        border-width: 2px !important;
        font-size: 1.2rem !important;
        padding: 0 !important;
        z-index: 3000 !important;
      }
    }
    .summary-btn {
      font-size: clamp(1.4rem, 2.2vw, 1.8rem);
      font-weight: bold;
      padding: clamp(6px, 1.5vw, 10px) clamp(15px, 3vw, 27px);
      border-radius: 9px;
      border: 3px solid #217093;
      background: #fff;
      color: #217093;
      cursor: pointer;
      margin-right: 4px;
      box-shadow: 2px 2px 4px #0001;
      transition: background 0.2s, color 0.2s, font-size 0.2s, padding 0.2s;
      white-space: nowrap;
    }
    .summary-btn:hover {
      background: #217093;
      color: #fff;
    }
    .summary-popup {
      display: none;
      position: absolute;
      top: 5%;
      left: 50%;
      width: 48%;
      min-width: 240px;
      max-width: 98%;
      min-height: 200px;
      max-height: 80vh;
      background: #fff;
      border: 3px solid #222;
      border-radius: 12px;
      box-shadow: 0 4px 24px #0003;
      padding: 36px 40px 32px 40px;
      font-size: 2.2rem;
      color: #222;
      z-index: 1000;
      line-height: 1.7;
      overflow-y: auto;
      transform: translateX(-2%);
    }
    .summary-popup .close-btn {
      position: absolute;
      top: 10px;
      right: 18px;
      cursor: pointer;
      font-size: 1.5rem;
      color: #888;
      font-weight: bold;
    }
    .destination-intro-popup {
      display: none;
      position: absolute;
      top: 5%;
      left: 50%;
      width: 48%;
      min-width: 240px;
      max-width: 98%;
      min-height: 200px;
      background: #fff;
      border: 3px solid #217093;
      border-radius: 12px;
      box-shadow: 0 4px 24px #0003;
      padding: 36px 40px 32px 40px;
      font-size: 2.2rem;
      color: #222;
      z-index: 2000;
      line-height: 1.7;
      overflow-y: auto;
      transform: translateX(-2%);
    }
    .destination-intro-popup .close-btn {
      position: absolute;
      top: 10px;
      right: 18px;
      cursor: pointer;
      font-size: 1.5rem;
      color: #888;
      font-weight: bold;
    }
    .destination-intro-popup .title {
      font-size: 2.8rem;
      font-weight: bold;
      color: #217093;
      margin-bottom: 20px;
      text-align: center;
    }
    .destination-intro-popup .guide-text {
      font-size: 2.2rem;
      line-height: 1.8;
      text-align: justify;
    }
    @media (max-width: 1000px) {
      .summary-popup {
        width: 96vw;
        left: 2vw;
        min-width: 0;
        max-width: 98vw;
        padding: 18px 8px 14px 8px;
        font-size: 1.5rem;
        transform: none;
      }
      .destination-intro-popup {
        width: 96vw;
        left: 2vw;
        min-width: 0;
        max-width: 98vw;
        padding: 18px 8px 14px 8px;
        font-size: 1.5rem;
        transform: none;
      }
      .destination-intro-popup .title {
        font-size: 1.8rem;
        margin-bottom: 15px;
      }
      .destination-intro-popup .guide-text {
        font-size: 1.5rem;
        line-height: 1.6;
      }
    }
    .details-popup {
      display: none;
      position: absolute;
      top: 50px;
      left: 50%;
      transform: translateX(-100%);
      width: 117vw;
      max-width: 780px;
      max-height: 80vh;
      background: #fff;
      border: 3px solid #333;
      border-radius: 12px;
      box-shadow: 0 8px 30px #0000004d;
      font-size: 1.6rem;
      color: #333;
      z-index: 2000;
      line-height: 1.7;
      overflow-y: auto;
    }
    .details-popup-content {
      padding: 24px;
      display: flex;
      flex-direction: column;
    }
    .details-popup .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
      font-size: 2rem;
      color: #aaa;
      font-weight: bold;
    }
    .details-popup-header {
      font-size: 2.4rem;
      font-weight: bold;
      color: #217093;
      margin-bottom: 16px;
      border-bottom: 2px solid #eee;
      padding-bottom: 12px;
    }
    .details-popup-content .detail-item {
      margin-bottom: 12px;
      display: grid;
      grid-template-columns: max-content 1fr;
      align-items: center;
      gap: 15px;
    }
    .details-popup-content .detail-item .label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: bold;
      color: #555;
    }
    .details-popup-content .detail-item .value {
      overflow-wrap: break-word;
    }
    .details-popup-content .detail-item .value a {
      color: #1a0dab;
      text-decoration: none;
      font-weight: 500;
    }
    .details-popup-content .detail-item .value a:hover {
      text-decoration: underline;
    }
    .details-popup .reviews-section {
      margin-top: 20px;
      border-top: 2px solid #eee;
      padding-top: 15px;
    }
    .details-popup .reviews-section .review {
      margin-bottom: 15px;
      font-size: 1.4rem;
      line-height: 1.6;
    }
    .details-popup .reviews-section .review-author {
      font-weight: bold;
      color: #217093;
    }
    @media (max-width: 600px) {
      .details-popup {
        font-size: 1.4rem;
      }
      .details-popup-header {
        font-size: 2rem;
      }
    }
    /* ì½”ìŠ¤ ì¶”ì²œ íŒì—… ë‚´ ê° ì½”ìŠ¤ êµ¬ë¶„ ìŠ¤íƒ€ì¼ */
    .course-block {
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      background: #f9f9fc;
      margin-bottom: 28px;
      padding: 22px 18px 18px 18px;
      box-shadow: 0 2px 8px #0001;
    }
    .course-block.course-1 {
      border-color: #8ecae6;
      background: #e0f7fa;
    }
    .course-block.course-2 {
      border-color: #ffd166;
      background: #fffbe6;
    }
    .course-block.course-3 {
      border-color: #b7e4c7;
      background: #f1faee;
    }
    .course-block:last-child { margin-bottom: 0; }
    .course-title {
      font-size: 2.6rem; font-weight: 900; margin-bottom: 14px; color: #217093; display: flex; align-items: center; gap: 8px; letter-spacing: 0.5px; }
    .course-rating { font-weight: bold; color: #e6b800; margin-top: 8px; }
    .course-block blockquote { border-left: 4px solid #217093; background: #eef6fa; margin: 12px 0; padding: 8px 16px; color: #217093; font-size: 1.1em; }
    .course-block p { margin: 8px 0; }
    .course-intro {
      font-size: 2.1rem;
      font-weight: 900;
      color: #222;
      margin-bottom: 32px;
      line-height: 1.5;
      letter-spacing: 0.5px;
    }
    .course-btn {
      font-size: inherit;
      font-weight: bold;
      padding: 12px 24px;
      border-radius: 4px;
      margin-left: 10px;
      background: #27ae60;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
      box-sizing: border-box;
      display: inline-block;
      vertical-align: middle;
    }
    .course-btn:hover {
      background: #219150;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-title">Travel Here Service</div>
    <div class="header-search">
      <input id="destination" placeholder="í˜„ì¬ ìœ„ì¹˜ ê²€ìƒ‰ ê²°ê³¼" style="color:#888;" />
      <button id="searchBtn">ê²€ìƒ‰</button>
      <button id="courseBtn" class="course-btn">ì¶”ì²œì½”ìŠ¤</button>
    </div>
  </div>
  
  <!-- SoundCloud ìŒì•… í”Œë ˆì´ì–´ ì¶”ê°€ -->
  <div style="text-align: center; padding: 20px; background: #f9f9f9; border-bottom: 1px solid #ddd;">
    <h3 style="margin: 0 0 10px 0; color: #217093;">ğŸµ ì—¬í–‰ ìŒì•… - ì„¸ë¸í‹´ Pretty U</h3>
    <iframe
      id="scPlayer"
      width="300"
      height="166"
      scrolling="no"
      frameborder="no"
      allow="autoplay"
      src="https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/sunnyb007/pretty-u-seventeen&volume=10&color=ff5500">
    </iframe>
  </div>
  
  <div class="main">
    <div class="map-container">
      <div id="map"></div>
      <div id="summaryBox" class="summary-popup" style="display:none;"></div>
      <div id="destinationIntroBox" class="destination-intro-popup" style="display:none;"></div>
    </div>
    <div class="side-tables">
      <div class="table-section attraction-table">
        <div class="table-title">
          <button id="attractionSummaryBtn" class="summary-btn">ìš”ì•½</button>
          <img src="/assets/attraction.png" alt="ê´€ê´‘ì§€" style="vertical-align:middle;width:3.52rem;height:3.52rem;margin:0 10px 0 10px;">
          ê´€ê´‘ì§€ 10ì„ 
        </div>
        <div class="table-container">
          <table id="attractionTable">
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="table-section restaurant-table">
        <div class="table-title">
          <button id="restaurantSummaryBtn" class="summary-btn">ìš”ì•½</button>
          <img src="/assets/restaurant.png" alt="ë§›ì§‘" style="vertical-align:middle;width:3.52rem;height:3.52rem;margin:0 10px 0 10px;">
          ë§›ì§‘ 10ì„ 
        </div>
        <div class="table-container">
          <table id="restaurantTable">
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div id="placeDetailsBox" class="details-popup" style="display:none;"></div>
  <div id="coursePopup" class="summary-popup" style="display:none;"></div>
  <script>
    const PROXY = 'https://moazine.onrender.com';
    let map, marker, destLatLng, attractions = [], restaurants = [];
    let placeMarkers = [];
    let speechVoices = [];
    let isVoicePlaying = false; // ìŒì„± ì¬ìƒ ìƒíƒœ ì¶”ì 
    let scWidget = null; // SoundCloud Widget ê°ì²´

    function loadVoices() {
      speechVoices = window.speechSynthesis.getVoices();
    }
    loadVoices();
    if (window.speechSynthesis.onvoiceschanged !== undefined) {
      window.speechSynthesis.onvoiceschanged = loadVoices;
    }

    // Google Maps JS API ë™ì  ë¡œë“œ
    async function loadGoogleMapAPI() {
      const response = await fetch(`${PROXY}/map-key`);
      const { apiKey } = await response.json();
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&libraries=places`;
      script.async = true;
      document.head.appendChild(script);
    }

    window.initMap = function() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 37.5665, lng: 126.9780 },
        zoom: 14
      });
      // ì²« ì§„ì… ì‹œ í˜„ì¬ ìœ„ì¹˜ë¡œ ìë™ ê²€ìƒ‰
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude, lng = pos.coords.longitude;
          map.setCenter({ lat, lng });
          if (marker) marker.setMap(null);
          marker = new google.maps.Marker({ position: { lat, lng }, map: map, title: 'í˜„ì¬ ìœ„ì¹˜', icon: { url: '/assets/current.png', scaledSize: new google.maps.Size(48, 48) } });
          destLatLng = { lat, lng };
          document.getElementById('destination').value = '';
          document.getElementById('destination').placeholder = 'í˜„ì¬ ìœ„ì¹˜ ê²€ìƒ‰ ê²°ê³¼';
          document.getElementById('destination').style.color = '#888';
          loadPlaces(true);
        }, () => {
          // ìœ„ì¹˜ ê¶Œí•œ ê±°ë¶€ ì‹œ ì„œìš¸ ê¸°ë³¸
          loadPlaces(true);
        });
      } else {
        loadPlaces(true);
      }
    };

    document.getElementById('destination').onfocus = function() {
      this.style.color = '#222';
      if (this.value === '') this.placeholder = '';
    };
    document.getElementById('destination').onblur = function() {
      if (this.value === '') {
        this.placeholder = 'í˜„ì¬ ìœ„ì¹˜ ê²€ìƒ‰ ê²°ê³¼';
        this.style.color = '#888';
      }
    };

    document.getElementById('searchBtn').onclick = function() {
      const dest = document.getElementById('destination').value;
      if (!dest) return alert('ëª©ì ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
      
      // ìŒì•… ì¬ìƒ ì‹œì‘
      const iframe = document.getElementById('scPlayer');
      if (iframe && !iframe.src.includes('auto_play=true')) {
        iframe.src += "&auto_play=true&volume=10";
      }
      
      // 'í˜„ì¬ìœ„ì¹˜', 'í˜„ìœ„ì¹˜', 'ì—¬ê¸°', 'ì´ê³³' ì…ë ¥ ì‹œ í˜„ì¬ ìœ„ì¹˜ë¡œ ê²€ìƒ‰
      const currentKeywords = ['í˜„ì¬ìœ„ì¹˜', 'í˜„ìœ„ì¹˜', 'ì—¬ê¸°', 'ì´ê³³'];
      if (currentKeywords.includes(dest.trim().replace(/\s/g, ''))) {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude, lng = pos.coords.longitude;
            destLatLng = { lat, lng };
            map.setCenter(destLatLng);
            if (marker) marker.setMap(null);
            marker = new google.maps.Marker({ position: destLatLng, map: map, title: 'í˜„ì¬ ìœ„ì¹˜', icon: { url: '/assets/current.png', scaledSize: new google.maps.Size(48, 48) } });
            document.getElementById('destination').value = '';
            document.getElementById('destination').placeholder = 'í˜„ì¬ ìœ„ì¹˜ ê²€ìƒ‰ ê²°ê³¼';
            document.getElementById('destination').style.color = '#888';
            loadPlaces(true);
          }, () => {
            alert('í˜„ì¬ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          });
        } else {
          alert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” í˜„ì¬ ìœ„ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
        return;
      }
      // ì¼ë°˜ ì£¼ì†Œ ê²€ìƒ‰
      fetch(`${PROXY}/geocode?query=${encodeURIComponent(dest)}`)
      .then(res => res.json())
      .then(data => {
        if (data.results && data.results.length > 0) {
          const loc = data.results[0].geometry.location;
          const placeName = data.results[0].formatted_address;
          destLatLng = { lat: loc.lat, lng: loc.lng };
          map.setCenter(destLatLng);
          if (marker) marker.setMap(null);
          marker = new google.maps.Marker({ position: destLatLng, map: map, title: 'ëª©ì ì§€' });
          document.getElementById('destination').style.color = '#222';
          // ëª©ì ì§€ ì†Œê°œ í‘œì‹œ (Gemini API í˜¸ì¶œ)
          showDestinationIntro(dest, placeName, destLatLng);
          loadPlaces(false);
        } else {
          alert('ëª©ì ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
      })
      .catch(error => {
        console.error('ì§€ì˜¤ì½”ë”© ì—ëŸ¬:', error);
        alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    };

    // ê²€ìƒ‰ì°½ì—ì„œ ì—”í„°í‚¤ ì…ë ¥ ì‹œì—ë„ ê²€ìƒ‰ ë™ì‘
    document.getElementById('destination').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('searchBtn').click();
      }
    });

    function clearPlaceMarkers() {
      placeMarkers.forEach(m => m.setMap(null));
      placeMarkers = [];
    }

    function loadPlaces(isCurrentLocation) {
      clearPlaceMarkers();
      let url = `${PROXY}/places?lat=${destLatLng.lat}&lng=${destLatLng.lng}&radius=5000`;
      fetch(url)
      .then(res => res.json())
      .then(data => {
        attractions = data.attractions || [];
        restaurants = data.restaurants || [];
        renderTable('attractionTable', attractions, 'ê´€ê´‘ì§€');
        renderTable('restaurantTable', restaurants, 'ë§›ì§‘');
        // ê´€ê´‘ì§€/ë§›ì§‘ ë§ˆì»¤ í‘œì‹œ (ì•„ì´ì½˜ ì ìš©)
        attractions.forEach(place => {
          if (place.geometry && place.geometry.location) {
            const m = new google.maps.Marker({
              position: place.geometry.location,
              map: map,
              title: place.name,
              icon: {
                url: '/assets/attraction.png',
                scaledSize: new google.maps.Size(48, 48)
              }
            });
            m.addListener('click', function() {
              window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}`,'_blank');
            });
            placeMarkers.push(m);
          }
        });
        restaurants.forEach(place => {
          if (place.geometry && place.geometry.location) {
            const m = new google.maps.Marker({
              position: place.geometry.location,
              map: map,
              title: place.name,
              icon: {
                url: '/assets/restaurant.png',
                scaledSize: new google.maps.Size(48, 48)
              }
            });
            m.addListener('click', function() {
              window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}`,'_blank');
            });
            placeMarkers.push(m);
          }
        });
        // ê²€ìƒ‰ì°½ í‘œì‹œ
        if (isCurrentLocation) {
          document.getElementById('destination').value = '';
          document.getElementById('destination').placeholder = 'í˜„ì¬ ìœ„ì¹˜ ê²€ìƒ‰ ê²°ê³¼';
          document.getElementById('destination').style.color = '#888';
        }
      });
    }

    function renderTable(tableId, list, type) {
      const tbody = document.getElementById(tableId).querySelector('tbody');
      let html = '';
      const maxRows = 10;

      if (list.length === 0) {
        // ë°ì´í„°ê°€ ì—†ì„ ë•Œ 10ê°œì˜ ë¹ˆ í•­ëª© í‘œì‹œ
        for (let i = 0; i < maxRows; i++) {
          html += `<tr><td style='width:48px;text-align:center;color:#888;white-space:nowrap;'>${i+1}.</td><td style='color:#888;'>í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì¶”ì²œí•  ê³³ì´ ì—†ìŠµë‹ˆë‹¤</td><td class='score'></td></tr>`;
        }
      } else {
        // ë°ì´í„°ê°€ ìˆì„ ë•Œ ìµœëŒ€ 10ê°œë§Œ í‘œì‹œ
        html = list.slice(0, maxRows).map((item, i) =>
          `<tr class="clickable" onclick="showPlaceInfo('${type}', '${item.place_id}')">
            <td style="width:48px;text-align:center;white-space:nowrap;">${i+1}.</td>
            <td>${item.name}</td>
            <td class="score">${item.rating ? item.rating.toFixed(1) + 'ì ' : '-'}</td>
          </tr>`
        ).join('');
        // 10ê°œ ë¯¸ë§Œì¼ ë•Œ ë¹ˆ í•­ëª©ìœ¼ë¡œ ì±„ì›€
        if (list.length < maxRows) {
          for (let i = list.length; i < maxRows; i++) {
            html += `<tr><td style='width:48px;text-align:center;color:#888;white-space:nowrap;'>${i+1}.</td><td style='color:#888;'>í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì¶”ì²œí•  ê³³ì´ ì—†ìŠµë‹ˆë‹¤</td><td class='score'></td></tr>`;
          }
        }
      }
      tbody.innerHTML = html;
    }

    window.showPlaceInfo = function(type, placeId) {
      if (!placeId) {
        alert('ì¥ì†Œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const box = document.getElementById('placeDetailsBox');
      box.innerHTML = `<div style="padding: 40px; text-align:center;">ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>`;
      box.style.display = 'block';

      fetch(`${PROXY}/place-details?place_id=${placeId}`)
        .then(res => res.json())
        .then(details => {
          if (details.error) throw new Error(details.error);
          
          let contentHtml = `<span class='close-btn' onclick="closeDetailsBox()">âœ•</span>`;
          
          let detailsHtml = `<div class="details-popup-content">`;
          detailsHtml += `<div class="details-popup-header">${details.name || 'ì´ë¦„ ì •ë³´ ì—†ìŒ'}</div>`;
          
          const detailsContent = [
            { icon: 'ğŸ“', text: 'ì£¼ì†Œ', value: details.formatted_address },
            { icon: 'â­', text: 'í‰ì ', value: details.rating ? `${details.rating.toFixed(1)}ì ` : null },
            { icon: 'ğŸ“', text: 'ì—°ë½ì²˜', value: details.formatted_phone_number, link: `tel:${details.formatted_phone_number}` },
            { icon: 'ğŸ’°', text: 'ê°€ê²©ëŒ€', value: details.price_level ? 'â‚©'.repeat(details.price_level) : null },
            { icon: 'ğŸŒ', text: 'ì›¹ì‚¬ì´íŠ¸', value: details.website, link: details.website }
          ];

          detailsContent.forEach(item => {
            if (item.value) {
              detailsHtml += `
                <div class="detail-item">
                  <div class="label">
                    <span class="icon">${item.icon}</span>
                    <span>${item.text}</span>
                  </div>
                  <div class="value">${item.link ? `<a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.value}</a>` : item.value}</div>
                </div>`;
            }
          });

          // ì›¹ì‚¬ì´íŠ¸ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ë©”ë‰´/ì…ì¥ë£Œ ì•ˆë‚´ ë¬¸êµ¬ ì¶”ê°€
          if (details.website) {
            const guidanceText = `ìì„¸í•œ ${type === 'ë§›ì§‘' ? 'ë©”ë‰´' : 'ì…ì¥ë£Œ'} ì •ë³´ëŠ” ìœ„ ê³µì‹ ì›¹ì‚¬ì´íŠ¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`;
            detailsHtml += `
              <div class="detail-item">
                <div class="label">
                  <span class="icon">â„¹ï¸</span>
                  <span>ì•ˆë‚´</span>
                </div>
                <div class="value"><small>${guidanceText}</small></div>
              </div>`;
          }

          detailsHtml += '</div>';

          if (details.reviews && details.reviews.length > 0) {
            detailsHtml += `<div class="reviews-section details-popup-content">`;
            detailsHtml += `
              <div class="detail-item">
                <div class="label" style="color: #217093;">
                  <span class="icon">ğŸ—£ï¸</span>
                  <span>ë°©ë¬¸ì ë¦¬ë·°</span>
                </div>
              </div>`;
            details.reviews.slice(0, 2).forEach(review => {
              detailsHtml += `<div class="review">
                <div><span class="review-author">${review.author_name}</span> (${review.relative_time_description})</div>
                <p style="margin: 5px 0 0; white-space: pre-wrap;">${review.text}</p>
              </div>`;
            });
            detailsHtml += `</div>`;
          }
          
          box.innerHTML = contentHtml + detailsHtml;
        })
        .catch(err => {
          console.error('Failed to get place details:', err);
          box.innerHTML = `<span class='close-btn' onclick="closeDetailsBox()">âœ•</span><div style="padding: 40px; text-align:center;">ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
        });
    };

    function closeDetailsBox() {
      document.getElementById('placeDetailsBox').style.display = 'none';
    }

    // ìš”ì•½ ì •ë³´ ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('attractionSummaryBtn').onclick = function() {
      showSummary('ê´€ê´‘ì§€', attractions);
    };
    document.getElementById('restaurantSummaryBtn').onclick = function() {
      showSummary('ë§›ì§‘', restaurants);
    };

    function showSummary(type, list) {
      if (!list || list.length === 0) {
        showSummaryBox('ìš”ì•½í•  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      showSummaryBox('ìš”ì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
      fetch('https://moazine.onrender.com/summarize', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ places: list, type })
      })
      .then(res => res.json())
      .then(data => {
        showSummaryBox(data.summary || 'ìš”ì•½ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      })
      .catch(() => showSummaryBox('ìš”ì•½ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'));
    }

    function getSpeechText(text) {
      // 1. ì¤„ ì‹œì‘ì˜ ë²ˆí˜¸ë¥¼ í•œêµ­ì–´ ì„œìˆ˜ë¡œ ë¨¼ì € ë³€í™˜í•©ë‹ˆë‹¤. (ë©€í‹°ë¼ì¸ `m` í”Œë˜ê·¸ ì‚¬ìš©)
      let speech = text.replace(/^1\./gm, 'ì²«ë²ˆì§¸')
                       .replace(/^2\./gm, 'ë‘ë²ˆì§¸')
                       .replace(/^3\./gm, 'ì…‹ë²ˆì§¸')
                       .replace(/^4\./gm, 'ë„¤ë²ˆì§¸')
                       .replace(/^5\./gm, 'ë‹¤ì„¯ë²ˆì§¸');

      // 2. ê´„í˜¸ì™€ ê´„í˜¸ ì•ˆì˜ ë‚´ìš©, ê·¸ ì™¸ ê¸°í˜¸ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤.
      speech = speech
        .replace(/\([^\)]*\)/g, '') // ( ... ) ì „ì²´ ì œê±°
        .replace(/[\[\]\-Â·*=_~^|#@$%&+=â†’â€¢â–ªï¸ğŸ¯ğŸŒŸğŸ’âœˆï¸ğŸ‘âœ…âœ”ğŸ’¯â£ï¸]/g, ' ') // ìŒì„± ì¶œë ¥ì— ë¶ˆí•„ìš”í•œ íŠ¹ìˆ˜ê¸°í˜¸ ë° ì´ëª¨ì§€ ì œê±°
        .replace(/:/g, 'ì€')
        .replace(/\//g, ' ë˜ëŠ” ')
        .replace(/í‰ì /g, 'í‰ì ì€');

      // 3. ì‹¤ìˆ˜í˜• ì ìˆ˜ë¥¼ í•œêµ­ì–´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. (ì˜ˆ: 4.5ì  -> 4ì 5)
      speech = speech.replace(/(\d+)\.(\d+)ì /g, '$1ì $2');
      
      // 4. ì„œìˆ˜ë‚˜ í‰ì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì§€ ì•Šì€, ë³¸ë¬¸ì— ë‚¨ì€ 'ìˆ«ì.' í˜•ì‹ì˜ ì ì„ ì œê±°í•©ë‹ˆë‹¤.
      speech = speech.replace(/(\d)\./g, '$1');

      // 5. ë§ˆì§€ë§‰ìœ¼ë¡œ ì¤„ë°”ê¿ˆê³¼ ì—¬ëŸ¬ ê³µë°±ì„ í•˜ë‚˜ì˜ ê³µë°±ìœ¼ë¡œ í†µì¼í•©ë‹ˆë‹¤.
      speech = speech.replace(/\n/g, ' ').replace(/\s{2,}/g, ' ').trim();
        
      return speech;
    }

    function showSummaryBox(text) {
      const box = document.getElementById('summaryBox');
      box.innerHTML = `<span class='close-btn' onclick="closeSummaryBox()">âœ•</span>` + text;
      box.style.display = 'block';
      // ìŒì„± ì¶œë ¥ (ì—¬í–‰ ê°€ì´ë“œ ì¸íŠ¸ë¡œ, ì˜µì…˜ ì¡°ì •)
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel(); // ê¸°ì¡´ ìŒì„± ì¤‘ì§€
        const speechText = getSpeechText(text);
        const utter = new SpeechSynthesisUtterance(speechText);
        utter.lang = 'ko-KR';
        utter.rate = 0.9; // ì¡°ê¸ˆ ë” ì²œì²œíˆ
        utter.pitch = 1; // ìì—°ìŠ¤ëŸ¬ìš´ ë†’ì´
        utter.volume = 1.0; // ìµœëŒ€ ë³¼ë¥¨ìœ¼ë¡œ ì„¤ì •
        // ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ voice ì„ íƒ
        const koVoice = speechVoices.find(v => v.lang === 'ko-KR' && v.name.includes('Google'));
        if (koVoice) utter.voice = koVoice;
        
        // ìŒì„± ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        setupSpeechEvents(utter);
        
        window.speechSynthesis.speak(utter);
      }
    }

    function closeSummaryBox() {
      document.getElementById('summaryBox').style.display = 'none';
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
      }
      // ìŒì„± ì¢…ë£Œ ì‹œ ìŒì•… í”Œë ˆì´ì–´ ë³µì›
      restoreMusicPlayer();
    }

    function showDestinationIntro(searchQuery, placeName, latLng) {
      const box = document.getElementById('destinationIntroBox');
      box.innerHTML = `
        <span class='close-btn' onclick="closeDestinationIntro()">âœ•</span>
        <div class="title">ğŸ¯ ${searchQuery} ì—¬í–‰ ê°€ì´ë“œ</div>
        <div class="guide-text">ê°€ì´ë“œ ì •ë³´ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>
      `;
      box.style.display = 'block';

      // ì„œë²„ì— Gemini ì†Œê°œ ìƒì„± ìš”ì²­
      fetch(`${PROXY}/generate-intro`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: searchQuery, address: placeName, lat: latLng.lat, lng: latLng.lng })
      })
      .then(res => res.json())
      .then(data => {
        const introText = data.intro.replace(/\n/g, '<br>'); // ì¤„ë°”ê¿ˆì„ <br>ë¡œ
        const guideTextElement = box.querySelector('.guide-text');
        if (guideTextElement) {
          guideTextElement.innerHTML = introText;
        }

        // ìŒì„± ì¶œë ¥
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
          const speechText = getDestinationSpeechText(introText);
          const utter = new SpeechSynthesisUtterance(speechText);
          utter.lang = 'ko-KR';
          utter.rate = 0.9; // ì¡°ê¸ˆ ë” ì²œì²œíˆ
          utter.pitch = 1; // ìì—°ìŠ¤ëŸ¬ìš´ ë†’ì´
          utter.volume = 1.0; // ìµœëŒ€ ë³¼ë¥¨ìœ¼ë¡œ ì„¤ì •
          const koVoice = speechVoices.find(v => v.lang === 'ko-KR' && v.name.includes('Google'));
          if (koVoice) utter.voice = koVoice;
          
          // ìŒì„± ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
          setupSpeechEvents(utter);
          
          window.speechSynthesis.speak(utter);
        }
      })
      .catch(err => {
        console.error('Failed to get destination intro:', err);
        const guideTextElement = box.querySelector('.guide-text');
        if (guideTextElement) {
          guideTextElement.innerHTML = 'ê°€ì´ë“œ ì •ë³´ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
        }
      });
    }

    function getDestinationSpeechText(text) {
      // HTML íƒœê·¸ ì œê±° ë° ìŒì„±ìš© í…ìŠ¤íŠ¸ ì •ë¦¬
      let speech = text.replace(/<[^>]*>/g, '') // HTML íƒœê·¸ ì œê±°
                       .replace(/[\[\]\-Â·*=_~^|#@$%&+=â†’â€¢â–ªï¸ğŸ¯ğŸŒŸğŸ’âœˆï¸ğŸ‘âœ…âœ”ğŸ’¯â£ï¸]/g, ' ') // ìŒì„± ì¶œë ¥ì— ë¶ˆí•„ìš”í•œ íŠ¹ìˆ˜ê¸°í˜¸ ë° ì´ëª¨ì§€ ì œê±°
                       .replace(/\n/g, ' ') // ì¤„ë°”ê¿ˆì„ ê³µë°±ìœ¼ë¡œ
                       .replace(/\s{2,}/g, ' ') // ì—¬ëŸ¬ ê³µë°±ì„ í•˜ë‚˜ë¡œ
                       .trim();
      
      return speech;
    }

    function closeDestinationIntro() {
      document.getElementById('destinationIntroBox').style.display = 'none';
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
      }
      // ìŒì„± ì¢…ë£Œ ì‹œ ìŒì•… í”Œë ˆì´ì–´ ë³µì›
      restoreMusicPlayer();
    }

    // ì¶”ì²œì½”ìŠ¤ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('courseBtn').onclick = function() {
      showCoursePopup();
    };

    function showCoursePopup() {
      if ((!attractions || attractions.length === 0) && (!restaurants || restaurants.length === 0)) {
        showCourseBox('ì¶”ì²œí•  ì½”ìŠ¤ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      showCourseBox('ì¶”ì²œ ì½”ìŠ¤ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...');
      fetch('https://moazine.onrender.com/generate-course', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ attractions, restaurants })
      })
      .then(res => res.json())
      .then(data => {
        showCourseBox(data.course || 'ì¶”ì²œ ì½”ìŠ¤ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      })
      .catch(() => showCourseBox('ì¶”ì²œ ì½”ìŠ¤ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'));
    }

    function showCourseBox(text) {
      const box = document.getElementById('coursePopup');
      // Gemini ì‘ë‹µì„ 3ê°€ì§€ ì½”ìŠ¤ë¡œ ë¶„ë¦¬ (###, --- ë“±ìœ¼ë¡œ êµ¬ë¶„)
      let courseHtml = '';
      const courseTitles = ['ì²«ë²ˆì§¸ ì½”ìŠ¤', 'ë‘ë²ˆì§¸ ì½”ìŠ¤', 'ì„¸ë²ˆì§¸ ì½”ìŠ¤'];
      const blocks = text.split(/(?:^|\n)[#\-]{2,}[^\n]*\n?/g).map(s => s.trim()).filter(Boolean);
      // ì•ˆë‚´ë¬¸êµ¬(ì¸íŠ¸ë¡œ)ê°€ ìˆëŠ” ê²½ìš° ì²« ë¸”ë¡ì´ ì¸íŠ¸ë¡œ, ë‚˜ë¨¸ì§€ê°€ ì½”ìŠ¤
      if (blocks.length > 2) {
        const intro = blocks[0];
        const courses = blocks.slice(1);
        courseHtml = `<div class=\"course-intro\">${intro.replace(/\n/g, '<br>')}</div>` +
          courses.map((block, idx) => {
            const title = courseTitles[idx] || `ì½”ìŠ¤ ${idx+1}`;
            return `<div class=\"course-block course-${idx+1}\"><div class=\"course-title\">${title}</div>${block.replace(/\n/g, '<br>')}</div>`;
          }).join('');
      } else if (blocks.length > 1) {
        courseHtml = blocks.map((block, idx) => {
          const title = courseTitles[idx] || `ì½”ìŠ¤ ${idx+1}`;
          return `<div class=\"course-block course-${idx+1}\"><div class=\"course-title\">${title}</div>${block.replace(/\n/g, '<br>')}</div>`;
        }).join('');
      } else {
        courseHtml = `<div class=\"course-block\"><div class=\"course-title\">ì²«ë²ˆì§¸ ì½”ìŠ¤</div>${text.replace(/\n/g, '<br>')}</div>`;
      }
      box.innerHTML = `<span class='close-btn' onclick=\"closeCourseBox()\">âœ•</span>` + courseHtml;
      box.style.display = 'block';
    }

    function closeCourseBox() {
      document.getElementById('coursePopup').style.display = 'none';
    }

    // ìŒì„± í•©ì„± ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    function setupSpeechEvents(utterance) {
      utterance.onstart = function() {
        dimMusicPlayer();
      };
      utterance.onend = function() {
        restoreMusicPlayer();
      };
      utterance.onerror = function() {
        restoreMusicPlayer();
      };
    }

    // ìŒì•… í”Œë ˆì´ì–´ ì‹œê°ì  ì œì–´ í•¨ìˆ˜ë“¤
    function dimMusicPlayer() {
      const iframe = document.getElementById('scPlayer');
      if (iframe && !isVoicePlaying) {
        isVoicePlaying = true;
        // iframeì„ ì‹œê°ì ìœ¼ë¡œ ì–´ë‘¡ê²Œ í‘œì‹œí•˜ì—¬ ìŒì„±ì´ ì¬ìƒ ì¤‘ì„ì„ ë‚˜íƒ€ëƒ„
        iframe.style.opacity = '0.3';
        iframe.style.filter = 'grayscale(50%)';
        iframe.style.transition = 'all 0.3s ease';
      }
    }

    function restoreMusicPlayer() {
      const iframe = document.getElementById('scPlayer');
      if (iframe && isVoicePlaying) {
        isVoicePlaying = false;
        // ì›ë˜ ìŠ¤íƒ€ì¼ë¡œ ë³µì›
        iframe.style.opacity = '1';
        iframe.style.filter = 'none';
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ Google Maps API ë¡œë“œ ì‹œì‘
    window.onload = function() {
      loadGoogleMapAPI();
    };
  </script>
</body>