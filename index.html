<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Moazine 관광지 안내 서비스 (Google Maps)</title>
  <style>
    #map { width: 100%; height: 400px; margin-bottom: 20px; }
    #controls { margin: 20px 0; }
    #attractions { margin: 20px 0; }
    .attraction-item { cursor: pointer; margin: 8px 0; padding: 6px; border: 1px solid #ccc; border-radius: 5px; }
    .attraction-item:hover { background: #f0f8ff; }
    #info { margin: 20px 0; }
  </style>
</head>
<body>
  <h1>Moazine 관광지 안내 서비스 (Google Maps)</h1>
  <div id="controls">
    <input id="destination" placeholder="목적지(예: 서울역)" />
    <button id="searchBtn">목적지 이동</button>
  </div>
  <div id="map"></div>
  <div id="attractions"></div>
  <div id="info"></div>
  <script>
    let map, marker, destLatLng, attractions = [];

    // Google Maps JS API 동적 로드
    async function loadGoogleMapAPI() {
      const response = await fetch('https://moazine.onrender.com/map-key');
      const { apiKey } = await response.json();
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&libraries=places`;
      script.async = true;
      document.head.appendChild(script);
    }

    window.initMap = function() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 37.5665, lng: 126.9780 },
        zoom: 13
      });
      // 현재 위치 마커
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude, lng = pos.coords.longitude;
          map.setCenter({ lat, lng });
          new google.maps.Marker({ position: { lat, lng }, map: map, title: '현재 위치' });
        });
      }
    };

    document.getElementById('searchBtn').onclick = function() {
      const dest = document.getElementById('destination').value;
      if (!dest) return alert('목적지를 입력하세요!');
      fetch(`https://moazine.onrender.com/geocode?query=${encodeURIComponent(dest)}`)
      .then(res => res.json())
      .then(data => {
        if (data.results && data.results.length > 0) {
          const loc = data.results[0].geometry.location;
          destLatLng = { lat: loc.lat, lng: loc.lng };
          map.setCenter(destLatLng);
          if (marker) marker.setMap(null);
          marker = new google.maps.Marker({ position: destLatLng, map: map, title: '목적지' });
          loadAttractions();
        } else {
          alert('목적지를 찾을 수 없습니다.');
        }
      });
    };

    function loadAttractions() {
      document.getElementById('attractions').innerHTML = '관광지 목록을 불러오는 중...';
      fetch(`https://moazine.onrender.com/attractions?lat=${destLatLng.lat}&lng=${destLatLng.lng}`)
      .then(res => res.json())
      .then(data => {
        attractions = data.results || [];
        if (attractions.length === 0) {
          document.getElementById('attractions').innerHTML = '주변 관광지를 찾을 수 없습니다.';
          return;
        }
        document.getElementById('attractions').innerHTML =
          '<b>주요 관광지 목록 (10개):</b><br>' +
          attractions.slice(0, 10).map((a, i) =>
            `<div class="attraction-item" data-idx="${i}">${a.name}</div>`
          ).join('');
        document.querySelectorAll('.attraction-item').forEach(item => {
          item.onclick = function() {
            const idx = this.getAttribute('data-idx');
            showAttractionInfo(attractions[idx]);
          };
        });
      });
    }

    function showAttractionInfo(attraction) {
      const name = attraction.name;
      const addr = attraction.vicinity || '';
      const rating = attraction.rating ? `평점: ${attraction.rating}` : '';
      const infoHtml = `
        <h3>${name}</h3>
        <p><b>주소:</b> ${addr}</p>
        <p><b>${rating}</b></p>
        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}" target="_blank">상세 정보 보기</a>
      `;
      document.getElementById('info').innerHTML = infoHtml;

      // 음성 안내
      let msg = `${name}. 주소는 ${addr}. ${rating}`;
      const utter = new SpeechSynthesisUtterance(msg);
      utter.lang = 'ko-KR';
      speechSynthesis.speak(utter);
    }

    // 페이지 로드 시 Google Maps API 로드 시작
    window.onload = loadGoogleMapAPI;
  </script>
</body>
</html> 